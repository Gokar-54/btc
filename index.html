<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¹ÙŠÙ† Ø§Ù„Ù†Ø³Ø± â€” Eagle Eye</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      background: #020617; 
      color: white; 
      font-family: system-ui, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-image: radial-gradient(circle at 15% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 20%),
                        radial-gradient(circle at 85% 30%, rgba(6, 182, 212, 0.05) 0%, transparent 20%),
                        radial-gradient(circle at 50% 80%, rgba(6, 182, 212, 0.07) 0%, transparent 20%);
    }
    .glass {
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    .counter-box { 
      transition: all 0.25s ease; 
      position: relative;
      overflow: hidden;
    }
    .counter-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #06b6d4, transparent);
    }
    .counter-box:hover { 
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(6, 182, 212, 0.15);
    }
    input {
      background: rgba(11, 18, 32, 0.7);
      border: 1px solid rgba(35, 48, 71, 0.7);
      padding: 0.75rem;
      border-radius: 0.75rem;
      color: #dbeafe;
      transition: all 0.2s;
    }
    input:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
    }
    .btn {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: #f0f9ff;
      padding: 0.6rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 700;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(6, 182, 212, 0.4);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: #e2e8f0;
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-2px);
    }
    .signal-strong {
      padding: 0.8rem 1.2rem;
      border-radius: 12px;
      font-weight: 800;
      animation: pulse 2s infinite;
    }
    .error-message { 
      color: #f87171; 
      font-size: 0.875rem; 
      margin-top: 0.5rem; 
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .success-message {
      color: #34d399;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .password-container {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
    }
    .floating-logo {
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .glow {
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
    }
    .gradient-text {
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-left: 8px;
    }
    .online {
      background-color: #10b981;
      box-shadow: 0 0 8px #10b981;
    }
    .system-info {
      border-left: 3px solid #06b6d4;
      padding-left: 12px;
      margin: 1rem 0;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6 flex items-center justify-center">
<!-- ========== AUTH (Login) ========== -->
<div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
  <div class="w-full max-w-md glass p-8 rounded-2xl mx-4">
    <div class="flex flex-col items-center text-center mb-8">
      <div class="floating-logo mb-4">
        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center glow">
          <i class="fas fa-eagle text-white text-4xl"></i>
        </div>
      </div>
      <h1 class="text-3xl font-bold gradient-text mb-2">EAGLE EYE SYSTEM</h1>
      <p class="text-sm opacity-80">Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>
      
      <div class="system-info text-sm text-right w-full mt-4">
        <p><i class="fas fa-shield-alt text-cyan-400 ml-2"></i> Ù†Ø¸Ø§Ù… Ø¢Ù…Ù† ÙˆÙ…Ø´ÙØ±</p>
        <p><i class="fas fa-database text-cyan-400 ml-2"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ²Ø§Ù…Ù†Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
        <p><i class="fas fa-chart-line text-cyan-400 ml-2"></i> ØªØ­Ù„ÙŠÙ„Ø§Øª ÙÙˆØ±ÙŠØ© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</p>
      </div>
    </div>
    
    <div class="mb-6">
      <div id="login-form">
        <div class="password-container mb-4">
          <input id="login-pass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…" type="password" class="w-full pl-12" />
          <button type="button" class="password-toggle" id="toggle-password">
            <i class="far fa-eye"></i>
          </button>
        </div>
        <div id="error-message" class="error-message hidden">
          <i class="fas fa-exclamation-circle"></i>
          <span>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</span>
        </div>
        <div id="success-message" class="success-message hidden">
          <i class="fas fa-check-circle"></i>
          <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
        </div>
        <div class="flex gap-3">
          <button id="btn-login" class="btn flex-1">
            <i class="fas fa-sign-in-alt"></i>
            Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
          </button>
        </div>
      </div>
    </div>
    
    <div class="text-center text-xs opacity-60 pt-4 border-t border-white/10">
      <p>Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø®ØµØµ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙ‚Ø·</p>
      <p class="mt-1">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2024</p>
    </div>
  </div>
</div>

<!-- ========== DASHBOARD ========== -->
<div id="dashboard" class="hidden w-full max-w-7xl">
  <!-- header -->
  <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-8">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center glow">
        <i class="fas fa-eagle text-white text-2xl"></i>
      </div>
      <div>
        <div class="text-2xl md:text-3xl font-extrabold gradient-text">EAGLE EYE SYSTEM</div>
        <div class="text-sm opacity-70 flex items-center">
          <span>Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­ÙŠØ© â€” <span id="current-symbol">BTC/USDT</span></span>
          <span class="status-indicator online"></span>
        </div>
      </div>
    </div>
    <div class="mr-auto flex flex-col md:flex-row items-start md:items-center gap-4">
      <div class="flex items-center gap-3">
        <label class="text-sm opacity-80">Ø±Ù…Ø² Ø§Ù„ØªØ¯Ø§ÙˆÙ„:</label>
        <select id="symbol-select" class="text-black p-2 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
          <option value="BTCUSDT">BTC/USDT</option>
          <option value="PAXGUSDT">PAXG/USDT</option>
          <option value="ETHUSDT">ETH/USDT</option>
          <option value="ADAUSDT">ADA/USDT</option>
        </select>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-sm opacity-80">
          <i class="far fa-clock ml-1"></i>
          <span id="now">--</span>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="logout" class="btn-secondary">
        <i class="fas fa-sign-out-alt"></i>
        Ø®Ø±ÙˆØ¬
      </button>
    </div>
  </div>
  
  <!-- SIGNAL BANNER -->
  <div id="signal-banner" class="mb-6"></div>
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 glass p-6 rounded-2xl">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div>
          <h2 class="text-lg opacity-80">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
          <div id="price" class="text-4xl font-extrabold text-cyan-300 mt-2">--</div>
          <div id="price-change" class="mt-1 opacity-80"></div>
        </div>
        <div class="text-right text-sm opacity-80 bg-black/20 p-3 rounded-xl">
          <div class="flex items-center justify-end">
            <i class="fas fa-sync-alt ml-2"></i>
            <span>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</span>
          </div>
          <div id="update-time" class="font-semibold mt-1">--</div>
          <div class="mt-2">Ø·Ù„Ø¨Ø§Øª API: <span id="requests">0</span></div>
        </div>
      </div>
      
      <hr class="my-6 border-white/10" />

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="glass p-4 rounded-xl text-center counter-box">
          <div class="text-xs opacity-70 mb-2">
            <i class="fas fa-shield-alt text-green-400 ml-1"></i>
            Ø§Ù„Ø¯Ø¹Ù…
          </div>
          <div id="support" class="text-2xl font-bold text-green-300">--</div>
        </div>
        <div class="glass p-4 rounded-xl text-center counter-box">
          <div class="text-xs opacity-70 mb-2">
            <i class="fas fa-ban text-red-400 ml-1"></i>
            Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©
          </div>
          <div id="resistance" class="text-2xl font-bold text-red-300">--</div>
        </div>
        <div class="glass p-4 rounded-xl text-center counter-box">
          <div class="text-xs opacity-70 mb-2">
            <i class="fas fa-bullhorn text-yellow-400 ml-1"></i>
            Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
          </div>
          <div id="signal" class="text-2xl font-bold text-yellow-300">âšª Ø§Ù†ØªØ¸Ø§Ø±</div>
          <div id="signal-txt" class="text-xs opacity-80 mt-1"></div>
        </div>
      </div>

      <hr class="my-6 border-white/10" />

      <h3 class="font-semibold mb-4 text-lg">
        <i class="fas fa-chart-bar text-cyan-400 ml-2"></i>
        Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="glass p-4 rounded-xl text-center counter-box">
          <div class="text-xs opacity-70 mb-2">Ø´Ø±Ø§Ø¡ ØªØ±Ø§ÙƒÙ…ÙŠ</div>
          <div id="cum-buys" class="text-2xl font-bold text-green-300">0.0000</div>
          <div class="text-xs opacity-70 mt-1">BTC</div>
        </div>
        <div class="glass p-4 rounded-xl text-center counter-box">
          <div class="text-xs opacity-70 mb-2">Ø¨ÙŠØ¹ ØªØ±Ø§ÙƒÙ…ÙŠ</div>
          <div id="cum-sells" class="text-2xl font-bold text-red-300">0.0000</div>
          <div class="text-xs opacity-70 mt-1">BTC</div>
        </div>
        <div class="glass p-4 rounded-xl text-center counter-box">
          <div class="text-xs opacity-70 mb-2">Ø§Ù„ÙØ±Ù‚ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</div>
          <div id="cum-diff" class="text-2xl font-bold text-cyan-300">0.0000</div>
          <div class="text-xs opacity-70 mt-1">BTC</div>
        </div>
      </div>
    </div>

    <div class="glass p-6 rounded-2xl">
      <h3 class="font-semibold mb-4 text-lg">
        <i class="fas fa-tachometer-alt text-cyan-400 ml-2"></i>
        Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±ÙŠØ©
      </h3>
      <div class="space-y-4">
        <div class="flex justify-between items-center p-3 bg-black/20 rounded-lg">
          <span class="opacity-80">Ø´Ø±Ø§Ø¡ / Ø«Ø§Ù†ÙŠØ©:</span>
          <span id="sec-buy" class="text-green-300 font-bold">0.0000</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-black/20 rounded-lg">
          <span class="opacity-80">Ø¨ÙŠØ¹ / Ø«Ø§Ù†ÙŠØ©:</span>
          <span id="sec-sell" class="text-red-300 font-bold">0.0000</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-black/20 rounded-lg">
          <span class="opacity-80">Ø§Ù„ÙØ±Ù‚ / Ø«Ø§Ù†ÙŠØ©:</span>
          <span id="sec-diff" class="text-cyan-300 font-bold">0.0000</span>
        </div>
      </div>

      <hr class="my-6 border-white/10" />
      
      <div class="text-sm opacity-80">
        <h4 class="font-semibold mb-3 text-cyan-300">
          <i class="fas fa-cogs ml-2"></i>
          Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        </h4>
        <div class="space-y-3">
          <div>
            <label class="block mb-1">Ø¹ØªØ¨Ø© Ø§Ù„ØªÙØ§ÙˆØª (BTC):</label>
            <input id="vol-threshold" class="w-full text-black rounded-lg px-3" value="10">
          </div>
          <div>
            <label class="block mb-1">ÙˆÙ‚Øª Ø§Ù„ØªØ¨Ø±ÙŠØ¯ (Ø«Ø§Ù†ÙŠØ©):</label>
            <input id="cooldown" class="w-full text-black rounded-lg px-3" value="20">
          </div>
        </div>
      </div>
      
      <hr class="my-6 border-white/10" />
      
      <div class="text-xs opacity-60">
        <p class="mb-2">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª: <span id="last-update">--</span></p>
        <p>ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙÙŠ: <span id="init-time">--</span></p>
      </div>
    </div>
  </div>
  
  <footer class="mt-8 text-center text-xs opacity-60 pt-4 border-t border-white/10">
    <p>Eagle Eye System â€” Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>
    <p class="mt-1">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.1.0 â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2024</p>
  </footer>
</div>

<script>
// ======== Authentication ========
const PASSWORD = "eagle2024"; // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù†Ø¸Ø§Ù…

// ======== State persistence ========
const GLOBAL_STATE_KEY = 'eagle_global_state_v4';

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ù† localStorage
function loadGlobalState() {
  const saved = JSON.parse(localStorage.getItem(GLOBAL_STATE_KEY) || 'null');
  
  if (!saved) {
    // Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©
    return {
      prevPrice: 0,
      cumBuys: 0,
      cumSells: 0,
      lastTradeId: null,
      secBuy: 0,
      secSell: 0,
      lastSecondTs: 0,
      requestCount: 0,
      volThreshold: 10,
      cooldownSec: 20,
      lastSignalTime: 0,
      currentSignal: 'âšª Ø§Ù†ØªØ¸Ø§Ø±',
      currentTxt: '',
      initializedAt: new Date().toISOString(),
      lastUpdate: new Date().toISOString()
    };
  }
  
  return saved;
}

let state = loadGlobalState();

// Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙŠ localStorage
function saveGlobalState() {
  state.lastUpdate = new Date().toISOString();
  localStorage.setItem(GLOBAL_STATE_KEY, JSON.stringify(state));
}

// ======== Authentication Handlers ========
document.getElementById('btn-login').addEventListener('click', handleLogin);

function handleLogin() {
  const p = document.getElementById('login-pass').value;
  const errorElement = document.getElementById('error-message');
  const successElement = document.getElementById('success-message');
  
  console.log("ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:", p);
  
  if (p === PASSWORD) {
    console.log("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØµØ­ÙŠØ­Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
    errorElement.classList.add('hidden');
    successElement.classList.remove('hidden');
    
    // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    setTimeout(() => {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard').classList.remove('hidden');
      startMonitor();
      successElement.classList.add('hidden');
    }, 1500);
  } else {
    console.log("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    errorElement.classList.remove('hidden');
    successElement.classList.add('hidden');
  }
}

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
document.getElementById('toggle-password').addEventListener('click', function() {
  const passwordInput = document.getElementById('login-pass');
  const icon = document.getElementById('toggle-password').querySelector('i');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
});

// Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('login-pass').addEventListener('keyup', (event) => {
  if (event.key === 'Enter') {
    handleLogin();
  }
});

document.getElementById('logout').addEventListener('click', () => {
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('login-pass').value = '';
  document.getElementById('error-message').classList.add('hidden');
});

// ======== API & helpers ========
let currentSymbol = 'BTCUSDT';

function fp(x){ return Number(x).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function f4(x){ return Number(x).toFixed(4); }

async function fetchJson(url){ 
  try{ 
    const r = await fetch(url); 
    if(!r.ok) throw new Error('Network error'); 
    state.requestCount++; 
    return await r.json(); 
  } catch(e){ 
    console.error('API Error:', e);
    return null; 
  } 
}

function supportRes(orderBook){
  try{
    const bids = (orderBook.bids||[]).map(b=>[+b[0],+b[1]]);
    const asks = (orderBook.asks||[]).map(a=>[+a[0],+a[1]]);
    const support = bids.length? bids.reduce((a,b)=> a[1]>b[1]?a:b)[0] : 0;
    const resistance = asks.length? asks.reduce((a,b)=> a[1]>b[1]?a:b)[0] : 0;
    return [support,resistance];
  }catch(e){ 
    console.error('Error calculating support/resistance:', e);
    return [0,0]; 
  }
}

function consumeTrades(trades){
  if(!trades || !trades.length) return [0,0];
  
  // ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù
  trades.sort((a,b)=>a.id-b.id);
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø­ÙØ¸ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù ÙˆØ¹Ø¯Ù… Ø­Ø³Ø§Ø¨ Ø£ÙŠ Ø´ÙŠØ¡
  if(state.lastTradeId===null){ 
    state.lastTradeId = trades.at(-1).id; 
    return [0,0]; 
  }
  
  let buy = 0, sell = 0, first = null, last = null;
  
  // Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
  for(const t of trades){ 
    if(t.id > state.lastTradeId){ 
      const q = +t.qty; 
      if(t.isBuyerMaker) 
        sell += q; 
      else 
        buy += q; 
      
      if(first === null) first = t.id;
      last = t.id;
    }
  }
  
  if(last !== null) state.lastTradeId = last;
  state.cumBuys += buy;
  state.cumSells += sell;
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ©
  const now = Math.floor(Date.now()/1000);
  if(now !== state.lastSecondTs){ 
    state.secBuy = buy; 
    state.secSell = sell; 
    state.lastSecondTs = now; 
  } else { 
    state.secBuy += buy; 
    state.secSell += sell; 
  }
  
  return [buy, sell];
}

// ======== SIGNAL LOGIC (Ø§Ù„ØªØ±Ø§ÙƒÙ… + ØªÙ‚Ø§Ø·Ø¹ Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©) ========
function computeSignal(price, support, resistance, prevPrice){
  // 1) ØªØ±Ø§ÙƒÙ…
  const buy = state.cumBuys; 
  const sell = state.cumSells;
  let accumSignal = 'âšª';
  if(buy > sell) accumSignal = 'ğŸŸ¢';
  else if(sell > buy) accumSignal = 'ğŸ”´';

  // 2) ØªÙ‚Ø§Ø·Ø¹ Ø§Ù„Ø³Ø¹Ø±
  let crossSignal = 'âšª';
  if(prevPrice <= resistance && price > resistance && resistance > 0) crossSignal = 'ğŸŸ¢';
  if(prevPrice >= support && price < support && support > 0) crossSignal = 'ğŸ”´';

  // 3) Ø¯Ù…Ø¬ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
  if(accumSignal === 'ğŸŸ¢' && crossSignal === 'ğŸŸ¢') 
    return {signal:'ğŸŸ¢ Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ', color:'green', reason:'ØªØ±Ø§ÙƒÙ… Ùˆ Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ù‚Ø§ÙˆÙ…Ø©'};
  if(accumSignal === 'ğŸ”´' && crossSignal === 'ğŸ”´') 
    return {signal:'ğŸ”´ Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ', color:'red', reason:'ØªØ±Ø§ÙƒÙ… ÙˆÙƒØ³Ø± Ø¯Ø¹Ù…'};
  if(accumSignal === 'ğŸŸ¢' && crossSignal === 'âšª') 
    return {signal:'ğŸŸ¢ Ø´Ø±Ø§Ø¡', color:'green', reason:'ØªØ±Ø§ÙƒÙ… Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø¨ÙŠØ¹'};
  if(accumSignal === 'ğŸ”´' && crossSignal === 'âšª') 
    return {signal:'ğŸ”´ Ø¨ÙŠØ¹', color:'red', reason:'ØªØ±Ø§ÙƒÙ… Ø¨ÙŠØ¹ Ø£Ø¹Ù„Ù‰'};
  if(accumSignal === 'âšª' && crossSignal === 'ğŸŸ¢') 
    return {signal:'ğŸŸ¢ Ø´Ø±Ø§Ø¡', color:'green', reason:'Ø§Ø®ØªØ±Ø§Ù‚ Ù…Ù‚Ø§ÙˆÙ…Ø©'};
  if(accumSignal === 'âšª' && crossSignal === 'ğŸ”´') 
    return {signal:'ğŸ”´ Ø¨ÙŠØ¹', color:'red', reason:'ÙƒØ³Ø± Ø¯Ø¹Ù…'};
  
  return {signal:'âšª Ø§Ù†ØªØ¸Ø§Ø±', color:'yellow', reason:'Ø´Ø±ÙˆØ· ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©'};
}

// ======== RENDER UI ========
function setSignalBanner(obj){
  const banner = document.getElementById('signal-banner');
  if(obj.signal.startsWith('ğŸŸ¢')){
    banner.innerHTML = `<div class="signal-strong bg-green-900/30 border border-green-700/50 text-green-300 flex items-center justify-center">
                          <i class="fas fa-arrow-up ml-2"></i>
                          ${obj.signal} â€” ${obj.reason}
                        </div>`;
  } else if(obj.signal.startsWith('ğŸ”´')){
    banner.innerHTML = `<div class="signal-strong bg-red-900/30 border border-red-700/50 text-red-300 flex items-center justify-center">
                          <i class="fas fa-arrow-down ml-2"></i>
                          ${obj.signal} â€” ${obj.reason}
                        </div>`;
  } else {
    banner.innerHTML = `<div class="signal-strong bg-yellow-900/20 border border-yellow-700/30 text-yellow-300 flex items-center justify-center">
                          <i class="fas fa-pause ml-2"></i>
                          ${obj.signal} â€” ${obj.reason}
                        </div>`;
  }
}

function render(price, support, resistance, prevPrice){
  const now = new Date();
  document.getElementById('now').textContent = now.toLocaleTimeString('ar');
  document.getElementById('update-time').textContent = now.toLocaleTimeString('ar');
  document.getElementById('requests').textContent = state.requestCount;
  document.getElementById('price').textContent = '$' + fp(price);
  
  const ch = price - (state.prevPrice || price);
  const changeElement = document.getElementById('price-change');
  changeElement.textContent = `${ch>=0? 'â–²':'â–¼'} ${Math.abs(ch).toFixed(2)} (${(ch/price*100).toFixed(2)}%)`;
  changeElement.style.color = ch >= 0 ? '#10b981' : '#ef4444';
  
  document.getElementById('support').textContent = support ? '$'+fp(support) : '--';
  document.getElementById('resistance').textContent = resistance ? '$'+fp(resistance) : '--';
  document.getElementById('cum-buys').textContent = f4(state.cumBuys);
  document.getElementById('cum-sells').textContent = f4(state.cumSells);
  document.getElementById('cum-diff').textContent = f4(state.cumBuys - state.cumSells);
  document.getElementById('sec-buy').textContent = f4(state.secBuy);
  document.getElementById('sec-sell').textContent = f4(state.secSell);
  document.getElementById('sec-diff').textContent = f4(state.secBuy - state.secSell);

  const sig = computeSignal(price, support, resistance, prevPrice);
  document.getElementById('signal').textContent = sig.signal;
  document.getElementById('signal').style.color = sig.color === 'green' ? '#10b981' : 
                                                sig.color === 'red' ? '#ef4444' : '#f59e0b';
  document.getElementById('signal-txt').textContent = sig.reason;
  setSignalBanner(sig);
  
  // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
  document.getElementById('init-time').textContent = new Date(state.initializedAt).toLocaleString('ar');
  document.getElementById('last-update').textContent = now.toLocaleString('ar');
}

// ======== MAIN LOOP ========
let running = false;
let apiSymbol = 'BTCUSDT';

document.getElementById('symbol-select').addEventListener('change', (e) => { 
  apiSymbol = e.target.value; 
  document.getElementById('current-symbol').textContent = e.target.value.replace('USDT','/USDT'); 
});

async function tick(){
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  state.volThreshold = +document.getElementById('vol-threshold').value;
  state.cooldownSec = +document.getElementById('cooldown').value;

  try {
    const ticker = await fetchJson(`https://api.binance.com/api/v3/ticker/24hr?symbol=${apiSymbol}`);
    if(!ticker) {
      console.error('Failed to fetch ticker');
      return;
    }
    
    const depth = await fetchJson(`https://api.binance.com/api/v3/depth?symbol=${apiSymbol}&limit=50`);
    const trades = await fetchJson(`https://api.binance.com/api/v3/trades?symbol=${apiSymbol}&limit=100`);

    const price = +ticker.lastPrice;
    const prevPrice = state.prevPrice || price;
    if(!state.prevPrice) state.prevPrice = price;

    const [support, resistance] = depth ? supportRes(depth) : [0, 0];
    consumeTrades(trades);
    render(price, support, resistance, prevPrice);
    state.prevPrice = price;
  } catch (error) {
    console.error('Error in tick function:', error);
  }
}

function startMonitor(){ 
  if(running) return; 
  running = true; 
  
  // Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
  document.getElementById('init-time').textContent = new Date(state.initializedAt).toLocaleString('ar');
  
  tick(); 
  setInterval(() => { 
    tick(); 
    saveGlobalState(); 
  }, 2000); 
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„
if(localStorage.getItem(GLOBAL_STATE_KEY)){ 
  // ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  // Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
  // document.getElementById('auth-screen').style.display = 'none'; 
  // document.getElementById('dashboard').classList.remove('hidden'); 
  // startMonitor(); 
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
console.log("Ù†Ø¸Ø§Ù… Eagle Eye Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…");
console.log("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: eagle2024");
</script>
</body>
</html>
